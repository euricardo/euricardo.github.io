!function(e,i){"use strict";function t(i,t){var s=R.eq(i);if(s.length&&void 0===W[i]){W[i]=!0;var n=e("<img/>"),a=!1;n.load(function(){n.unbind("load"),setTimeout(function(){c(n),r(),"function"==typeof t&&t()},1)}).bind("error",function(){!a&&E.errorBackground&&n.attr("src",E.errorBackground),a=!0}),setTimeout(function(){n.attr("src",s.attr("href")),e("div",m).eq(i).append(n)},1)}}function s(){return G===B-1?0:G+1}function n(){return 0===G?B-1:G-1}function a(e){return e[Math.floor(Math.random()*e.length)]}function o(e,i){"function"==typeof i&&i(),h.trigger(e)}function l(){O=e(i),P=e("body"),h=e('<div class="serene-outer"></div>').append(f=e('<div class="serene-overlay"></div>'),m=e('<div class="serene-stage"></div>'),b=e('<div class="serene-caption-outer"></div>').append(e('<div class="serene-caption-helper"></div>').append(g=e('<div class="serene-caption"></div>'))),k=e('<div class="serene-controls-outer"></div>').append(C=e('<div class="serene-controls"></div>').append(x=e('<div class="serene-prev"></div>'),T=e('<div class="serene-play"></div>'),L=e('<div class="serene-next"></div>')),S=e('<div class="serene-loading-wrap"></div>').append(q=e('<div class="serene-loading"></div>')),D=e('<div class="serene-close-wrap"></div>').append(Q=e('<div class="serene-close"></div>')))),P.append(h),L.click(function(){return F.next(),!1}),x.click(function(){return F.prev(),!1}),D.click(F.close),j=P.css("overflow"),P.delegate(".serene-element","click",function(i){i.preventDefault(),o(X,E.onOpen),f.css("opacity",E.opacity).add(m).show(),P.css("overflow","hidden"),K=!0,d(e(this))})}function d(i){R=i;var a=i.attr("rel");a&&(R=e(".serene-element").filter(function(){return this.rel===a}),G=R.index(i)),B=R.length;for(var o=0;o<B;o++)m.append('<div class="serene-slide"/>');if(B>1){if(C.show(),m.click(function(){L.click()}).css("cursor","pointer"),E.keyboard&&e(document).bind("keydown.serene",function(e){K&&27===e.keyCode&&(e.preventDefault(),F.close()),K&&B>1&&(37===e.keyCode?(e.preventDefault(),x.click()):39===e.keyCode&&(e.preventDefault(),L.click()))}),E.slideshow&&(E.slideshowAuto?F.start():F.stop(),T.show(),k.addClass("serene-slideshow")),E.bullets){A=e('<div class="serene-bullets"/>');for(var l=0;l<B;l++){var d=R.eq(l).data("title")||"";e('<div class="serene-bullet">'+l+"</div>").data("index",l).attr("title",d).appendTo(A)}e(".serene-bullet",A).click(function(){return F.go(e(this).data("index")),!1}),C.append(A)}}else k.addClass("serene-single");k.fadeIn(E.controlSpeed),B>2&&t(n());var c=setTimeout(function(){k.addClass("serene-load")},200);t(G,function(){clearTimeout(c),k.removeClass("serene-load"),O.resize(e.isFunction(e.throttle)?e.throttle(100,r):r),p()}),t(s())}function r(){var i=m.width(),t=m.height(),s=t/i;e("img",m).each(function(){var n=e(this),a=n.data("imageRatio"),o={};switch(s>a?E.fitAlways?n.width(i).height(i*a):a<=1&&E.fitLandscape?n.width(i).height(i*a):n.height(t).width(t/a):E.fitAlways?n.height(t).width(t/a):a>1&&E.fitPortrait?n.height(t).width(t/a):n.width(i).height(i*a),E.positionX){case"left":o.left=0,o.right="auto";break;case"right":o.left="auto",o.right=0;break;default:case"center":o.left=(i-n.width())/2+"px",o.right="auto"}switch(E.positionY){case"top":o.top=0,o.bottom="auto";break;case"bottom":o.top="auto",o.bottom=0;break;default:case"center":o.top=(t-n.height())/2+"px",o.bottom="auto"}n.css(o)})}function c(e){var i=e.width(),t=e.height();e.data({imageWidth:i,imageHeight:t,imageRatio:t/i})}function p(i){switch(o(Y,E.onLoad),J=!0,k.addClass("serene-animating"),e(".serene-prev-slide",m).removeClass("serene-prev-slide"),w=e(".serene-current-slide",m).removeClass("serene-current-slide").addClass("serene-prev-slide"),y=e("div:eq("+G+")",m),t(i?n():s()),v(),"none"===E.transition?b.hide():b.stop().animate({opacity:0},E.captionSpeed,function(){b.hide()}),y.css("visibility","hidden").addClass("serene-current-slide"),E.lowQuality&&m.addClass("serene-low"),E.transition){case"none":y.css("visibility","visible"),u();break;default:case"fade":y.animate({opacity:0},0).css("visibility","visible").animate({opacity:1},E.speed,E.easing,u);break;case"fadeOutFadeIn":var a=function(){y.animate({opacity:0},0).css("visibility","visible").animate({opacity:1},E.speed,E.easing,u)};w.length?w.animate({opacity:0},E.speed,E.easing,a):a();break;case"slideDown":i?y.animate({top:m.height()},0).css("visibility","visible").animate({top:0},E.speed,E.easing,u):y.animate({top:-m.height()},0).css("visibility","visible").animate({top:0},E.speed,E.easing,u);break;case"slideRight":i?y.animate({left:-m.width()},0).css("visibility","visible").animate({left:0},E.speed,E.easing,u):y.animate({left:m.width()},0).css("visibility","visible").animate({left:0},E.speed,E.easing,u);break;case"slideUp":i?y.animate({top:-m.height()},0).css("visibility","visible").animate({top:0},E.speed,E.easing,u):y.animate({top:m.height()},0).css("visibility","visible").animate({top:0},E.speed,E.easing,u);break;case"slideLeft":i?y.animate({left:m.width()},0).css("visibility","visible").animate({left:0},E.speed,E.easing,u):y.animate({left:-m.width()},0).css("visibility","visible").animate({left:0},E.speed,E.easing,u);break;case"carouselRight":i?(y.animate({left:-m.width()},0).css("visibility","visible").animate({left:0},E.speed,E.easing,u),w.animate({left:0},0).animate({left:m.width()},E.speed,E.easing)):(y.animate({left:m.width()},0).css("visibility","visible").animate({left:0},E.speed,E.easing,u),w.animate({left:-m.width()},E.speed,E.easing));break;case"carouselLeft":i?(y.animate({left:m.width()},0).css("visibility","visible").animate({left:0},E.speed,E.easing,u),w.animate({left:0},0).animate({left:-m.width()},E.speed,E.easing)):(y.animate({left:-m.width()},0).css("visibility","visible").animate({left:0},E.speed,E.easing,u),w.animate({left:m.width()},E.speed,E.easing))}}function u(){J=!1,E.lowQuality&&m.removeClass("serene-low");var i=R.eq(G),t=i.data("caption"),s=t?e(t).html():"",n=i.data("caption-position")||E.captionPosition;"random"===n&&(n=a(N)+" "+a(V)),s&&K&&(g.html(s),E.captionEnhancement.call(b),b.attr("class","serene-caption-outer").addClass("serene-position-"+n.split(" ").join("-")).stop().show().animate({opacity:1},E.captionSpeed)),k.removeClass("serene-animating"),o(z,E.onComplete)}function v(){E.bullets&&B>1&&A.children().removeClass("active-bullet").eq(G).addClass("active-bullet")}var h,f,m,b,g,w,y,k,C,x,T,L,S,q,D,Q,A,O,P,R,j,B,E,F,I,M={speed:2e3,transition:"fade",fitLandscape:!1,fitPortrait:!0,positionX:"center",positionY:"center",easing:"swing",slideshow:!0,slideshowAuto:!0,slideshowSpeed:5e3,keyboard:!0,captionPosition:"center bottom",captionSpeed:600,bullets:!0,lowQuality:!1,errorBackground:"",onOpen:!1,onLoad:!1,onComplete:!1,onCleanup:!1,onClose:!1,captionEnhancement:function(){}},X="sereneOpen",Y="sereneLoad",z="sereneComplete",H="sereneCleanup",U="sereneClose",W=[],G=0,J=!1,K=!1,N=["left","center","right"],V=["top","center","bottom"],Z=!1;F=e.fn.serene=function(i){var t=this;return!t[0]&&t.selector?t:(E=e.extend({},M,i||{}),t.each(function(){e(this).addClass("serene-element")}))},F.close=function(){o(H,E.onCleanup),J=!1,E.lowQuality&&m.removeClass("serene-low"),w&&w.length&&w.stop(),y&&y.length&&y.stop(),k.removeClass("serene-animating").stop(!0,!0).hide(),E.slideshow&&clearTimeout(I),e(".serene-slide",m).remove(),W=[],b.stop(!0,!0).hide().attr("class","serene-caption-outer"),g.html(""),E.bullets&&e(".serene-bullets",C).remove(),P.css("overflow",j),f.add(m).hide(),K=!1,E.keyboard&&e(document).unbind("keydown.serene"),o(U,E.onClose)},F.next=function(){return!J&&(G=s(),void p())},F.prev=function(){return!J&&(G=n(),void p(!0))},F.go=function(e){return!J&&G!==e&&void(e>G?(G=e,void 0===W[G]?t(G,p):p()):(G=e,void 0===W[G]?t(G,function(){p(!0)}):p()))},F.start=function(){E.slideshow&&!Z&&(Z=!0,h.bind(z,function(){I=setTimeout(F.next,E.slideshowSpeed)}).bind(Y,function(){clearTimeout(I)}).bind(H,F.stop),T.removeClass("serene-play").addClass("serene-pause").unbind("click").one("click",F.stop),I=setTimeout(F.next,E.slideshowSpeed))},F.stop=function(){E.slideshow&&(clearTimeout(I),h.unbind([z,Y,H].join(" ")),T.unbind("click").removeClass("serene-pause").addClass("serene-play").one("click",F.start),Z=!1)},e(document).ready(function(){l()})}(jQuery,window);